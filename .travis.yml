language: python

python:
  - "3.4"
  - "3.5"

env:
  global:
    # Dependencies
    - DEPS_DIR="`readlink -f $TRAVIS_BUILD_DIR/..`"
    - OPENCV_BUILD_DIR=$DEPS_DIR/opencv/build

before_install:
  - "sudo apt-get update -qq"
  - "sudo apt-get install --fix-missing mercurial python3-dev python3-numpy libav-tools libsdl-image1.2-dev libsdl-mixer1.2-dev libsdl-ttf2.0-dev libsmpeg-dev libsdl1.2-dev libportmidi-dev libswscale-dev libavformat-dev libavcodec-dev"
  - "pip install hg+http://bitbucket.org/pygame/pygame"
  - "pip install pytest-cov"
  - "pip install pytest-pep8"
  - "pip install python-coveralls"

  # Build Open CV
  - travis_retry git clone --depth 1 https://github.com/Itseez/opencv.git $DEPS_DIR/opencv
  - mkdir $OPENCV_BUILD_DIR && cd $OPENCV_BUILD_DIR
  - |
    cmake --debug-output \
          -D BUILD_TIFF=ON \
          -D BUILD_opencv_java=OFF \
          -D WITH_CUDA=OFF \
          -D ENABLE_AVX=ON \
          -D WITH_OPENGL=ON \
          -D WITH_OPENCL=ON \
          -D WITH_IPP=ON \
          -D WITH_TBB=ON \
          -D WITH_EIGEN=ON \
          -D WITH_V4L=ON \
          -D BUILD_TESTS=OFF \
          -D BUILD_PERF_TESTS=OFF \
          -D CMAKE_BUILD_TYPE=RELEASE \
          -D CMAKE_INSTALL_PREFIX=$(python3 -c "import sys; print(sys.prefix)") \
          -D PYTHON_EXECUTABLE=$(which python3) \
          -D PYTHON_INCLUDE_DIR=$(python3 -c "from distutils.sysconfig import get_python_inc; print(get_python_inc())") \
          -D PYTHON_PACKAGES_PATH=$(python3 -c "from distutils.sysconfig import get_python_lib; print(get_python_lib())") ..
  - make -j4
  - sudo make install
  - echo "/usr/local/lib" | sudo tee -a /etc/ld.so.conf.d/opencv.conf
  - sudo ldconfig
  - echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/local/lib/pkgconfig" | sudo tee -a /etc/bash.bashrc
  - echo "export PKG_CONFIG_PATH" | sudo tee -a /etc/bash.bashrc
  - export PYTHONPATH=$OPENCV_BUILD_DIR/lib/python3.3/site-packages:$PYTHONPATH 
  
# command to install dependencies
install:
  - "pip install -r requirements.txt"

# command to run tests
script:
  - py.test thin_client/test/
